# Load CSV files
$dimensions = Import-Csv -Path .\dimensions.csv
$expressions = Import-Csv -Path .\expressions.csv

# Load template JSON
$template = Get-Content -Raw -Path .\template.json | ConvertFrom-Json

# Create new table
$table = New-QlikSenseTable -qFields $template.qFields -qMeasures $template.qMeasures -qLayout $template.qLayout

# Add dimensions
foreach ($dimension in $dimensions) {
    $qDimension = New-Object PSObject -Property @{
        qDef = @{
            qFieldDefs = $dimension.qFieldDefs
            qSortCriterias = @()
        }
        qLabelExpression = @{
            qExpr = $dimension.qLabelExpression
        }
    }
    
    # Merge with template properties
    $qDimension = Merge-Object $template.qDimensions $qDimension

    $table.qDimensions += $qDimension
}

# Add expressions
foreach ($expression in $expressions) {
    $qMeasure = New-Object PSObject -Property @{
        qDef = @{
            qLabel = $expression.qLabelExpression
            qDef = $expression.qDef
            qLabelExpression = @{
                qExpr = $expression.qLabelExpression
            }
        }
    }
    
    # Merge with template properties
    $qMeasure = Merge-Object $template.qMeasures $qMeasure

    $table.qMeasures += $qMeasure
}

# Convert to JSON
$json = ConvertTo-Json $table -Depth 10

# Write to file
Set-Content -Path .\output.json -Value $json
